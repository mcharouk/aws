schemaVersion: '0.3'
description: Composite document for Quick Setup Managing Instances association. This document ensures IAM role for instance profile is created in account with all required policies
assumeRole: '{{AutomationAssumeRole}}'
parameters:
  AutomationAssumeRole:
    type: String
  InstanceId:
    type: String
  IsPolicyAttachAllowed:
    type: String
mainSteps:
  - name: getExistingRoleName
    action: aws:executeScript
    nextStep: branchIfProfileExists
    isEnd: false
    inputs:
      Script: |-
        import boto3

        def getInstanceProfileName(events, context):
            ec2_client = boto3.client("ec2")
            response = ec2_client.describe_instances(InstanceIds=[events["InstanceId"]])
            if 'IamInstanceProfile' in response['Reservations'][0]['Instances'][0]:
                return {'RoleName': response['Reservations'][0]['Instances'][0]['IamInstanceProfile']['Arn'].split('/').pop()}
            return {'RoleName': 'NoRoleFound'}
      Runtime: python3.8
      InputPayload:
        InstanceId: '{{InstanceId}}'
      Handler: getInstanceProfileName
    outputs:
      - Type: String
        Name: existingInstanceProfileRoleName
        Selector: $.Payload.RoleName
  - name: branchIfProfileExists
    action: aws:branch
    inputs:
      Choices:
        - NextStep: createRoleIfNotExists
          Variable: '{{getExistingRoleName.existingInstanceProfileRoleName}}'
          StringEquals: NoRoleFound
      Default: checkIfPolicyAttachAllowed
  - name: checkIfPolicyAttachAllowed
    action: aws:branch
    inputs:
      Choices:
        - NextStep: getRoleFromInstanceProfile
          Variable: '{{IsPolicyAttachAllowed}}'
          StringEquals: 'true'
      Default: createRoleIfNotExists
  - name: getRoleFromInstanceProfile
    action: aws:executeAwsApi
    nextStep: attachAmazonSSMManagedInstanceCoreToExistingRole
    isEnd: false
    inputs:
      InstanceProfileName: '{{getExistingRoleName.existingInstanceProfileRoleName}}'
      Service: iam
      Api: GetInstanceProfile
    outputs:
      - Type: String
        Name: existingRoleName
        Selector: $.InstanceProfile.Roles[0].RoleName
  - name: attachAmazonSSMManagedInstanceCoreToExistingRole
    action: aws:executeAwsApi
    nextStep: attachCloudWatchAgentServerPolicyToExistingRole
    isEnd: false
    inputs:
      RoleName: '{{getRoleFromInstanceProfile.existingRoleName}}'
      PolicyArn: arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Service: iam
      Api: AttachRolePolicy
  - name: attachCloudWatchAgentServerPolicyToExistingRole
    action: aws:executeAwsApi
    nextStep: attachAmazonSSMPatchAssociationToExistingRole
    isEnd: false
    inputs:
      RoleName: '{{getRoleFromInstanceProfile.existingRoleName}}'
      PolicyArn: arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      Service: iam
      Api: AttachRolePolicy
  - name: attachAmazonSSMPatchAssociationToExistingRole
    action: aws:executeAwsApi
    isEnd: true
    inputs:
      RoleName: '{{getRoleFromInstanceProfile.existingRoleName}}'
      PolicyArn: arn:aws:iam::aws:policy/AmazonSSMPatchAssociation
      Service: iam
      Api: AttachRolePolicy
  - description: Create AmazonSSMRoleForInstancesQuickSetup Role For SSM Quick Setup
    name: createRoleIfNotExists
    action: aws:executeAwsApi
    nextStep: assertRoleForInstanceProfileExists
    isEnd: false
    onFailure: step:assertRoleForInstanceProfileExists
    inputs:
      Path: /
      RoleName: AmazonSSMRoleForInstancesQuickSetup
      Description: EC2 role for SSM for Quick-Setup
      AssumeRolePolicyDocument: '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":{"Service":"ec2.amazonaws.com"},"Action":"sts:AssumeRole"}]}'
      Service: iam
      Api: CreateRole
  - name: assertRoleForInstanceProfileExists
    action: aws:assertAwsResourceProperty
    nextStep: attachAmazonSSMManagedInstanceCoreToRole
    isEnd: false
    inputs:
      PropertySelector: $.Role.RoleName
      RoleName: AmazonSSMRoleForInstancesQuickSetup
      DesiredValues:
        - AmazonSSMRoleForInstancesQuickSetup
      Service: iam
      Api: GetRole
  - name: attachAmazonSSMManagedInstanceCoreToRole
    action: aws:executeAwsApi
    nextStep: attachAmazonSSMPatchAssociationToRole
    isEnd: false
    inputs:
      RoleName: AmazonSSMRoleForInstancesQuickSetup
      PolicyArn: arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Service: iam
      Api: AttachRolePolicy
  - name: attachAmazonSSMPatchAssociationToRole
    action: aws:executeAwsApi
    nextStep: attachCloudWatchAgentServerPolicy
    isEnd: false
    inputs:
      RoleName: AmazonSSMRoleForInstancesQuickSetup
      PolicyArn: arn:aws:iam::aws:policy/AmazonSSMPatchAssociation
      Service: iam
      Api: AttachRolePolicy
  - name: attachCloudWatchAgentServerPolicy
    action: aws:executeAwsApi
    nextStep: createInstanceProfileIfNotExists
    isEnd: false
    inputs:
      PolicyArn: arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      RoleName: AmazonSSMRoleForInstancesQuickSetup
      Service: iam
      Api: AttachRolePolicy
  - name: createInstanceProfileIfNotExists
    action: aws:executeAwsApi
    nextStep: addRoleToInstanceProfile
    isEnd: false
    onFailure: step:addRoleToInstanceProfile
    inputs:
      InstanceProfileName: AmazonSSMRoleForInstancesQuickSetup
      Service: iam
      Api: CreateInstanceProfile
  - name: addRoleToInstanceProfile
    action: aws:executeAwsApi
    nextStep: executeAttachIAMToInstance
    isEnd: false
    onFailure: step:executeAttachIAMToInstance
    inputs:
      RoleName: AmazonSSMRoleForInstancesQuickSetup
      InstanceProfileName: AmazonSSMRoleForInstancesQuickSetup
      Service: iam
      Api: AddRoleToInstanceProfile
  - name: executeAttachIAMToInstance
    action: aws:executeAutomation
    maxAttempts: 10
    timeoutSeconds: 60
    isEnd: true
    inputs:
      RuntimeParameters:
        AutomationAssumeRole: '{{ AutomationAssumeRole }}'
        RoleName: AmazonSSMRoleForInstancesQuickSetup
        InstanceId: '{{ InstanceId }}'
        ForceReplace: false
      DocumentName: AWS-AttachIAMToInstance
